# 极低延迟直播推流软件技术文档

## 1. 项目概述

本项目旨在为Windows 10/11（64位）平台设计并实现一款独立的极低延迟直播推流软件。该软件在延迟、稳定性和画质表现上达到OBS低延迟模式水平，但不依赖OBS及其相关组件。

### 1.1 核心功能
- 屏幕采集：使用DXGI Desktop Duplication API实现高效屏幕捕获
- GPU硬编码：使用NVIDIA NVENC H.264硬件编码器，配置低延迟参数
- UDP视频流发送：开发自定义轻量级UDP视频流协议

### 1.2 技术目标
- **极低延迟**：采用丢帧策略而非卡顿缓冲，确保实时性
- **长期运行稳定性**：保障连续推流24小时以上无崩溃或性能下降
- **资源占用优化**：最小化CPU与GPU资源消耗，确保系统流畅运行

## 2. 系统架构

### 2.1 整体架构

```
+-------------------+     +-------------------+     +-------------------+
| 屏幕采集模块      |     | 视频编码模块      |     | 网络传输模块      |
| (ScreenCapture)   | --> | (NVEncoder)       | --> | (UDPTransmitter)  |
+-------------------+     +-------------------+     +-------------------+
        ^                         ^                         ^
        |                         |                         |
+-------------------+     +-------------------+     +-------------------+
| 采集线程          |     | 编码线程          |     | 传输线程          |
+-------------------+     +-------------------+     +-------------------+
        |                         |                         |
        +-------------------------+-------------------------+
                                  |
                          +-------------------+
                          | 主控制模块        |
                          | (LiveStreamer)    |
                          +-------------------+
                                  |
                          +-------------------+
                          | 配置管理模块      |
                          | (ConfigManager)   |
                          +-------------------+
```

### 2.2 模块职责

| 模块 | 主要职责 | 文件位置 |
|------|---------|----------|
| 屏幕采集模块 | 负责屏幕内容捕获，支持640×640中心裁剪，GPU加速处理 | include/ScreenCapture.h<br>src/ScreenCapture.cpp |
| 视频编码模块 | 负责使用NVENC进行H.264硬件编码，配置低延迟参数 | include/NVEncoder.h<br>src/NVEncoder.cpp |
| 网络传输模块 | 负责将编码后的视频数据通过UDP协议发送，实现自定义轻量级协议 | include/UDPTransmitter.h<br>src/UDPTransmitter.cpp |
| 主控制模块 | 负责协调各模块工作，实现多线程架构 | include/LiveStreamer.h<br>src/LiveStreamer.cpp |
| 配置管理模块 | 负责加载和管理配置，支持JSON文件和命令行参数 | include/ConfigManager.h<br>src/ConfigManager.cpp |
| 无锁队列 | 负责线程间通信，确保数据高效传输 | include/LockFreeQueue.h |

## 3. 核心模块详解

### 3.1 屏幕采集模块 (ScreenCapture)

#### 3.1.1 技术实现
- 使用DXGI Desktop Duplication API实现屏幕捕获
- 支持指定显示器索引进行采集
- 实现640×640中心裁剪，确保画面居中
- 使用GPU加速进行裁剪和缩放操作，避免CPU-GPU数据传输

#### 3.1.2 关键参数
- **displayIndex**：显示器索引，默认为0
- **outputWidth**：输出宽度，默认为640
- **outputHeight**：输出高度，默认为640

#### 3.1.3 性能优化
- 使用DirectX 11进行GPU加速处理
- 最小化CPU-GPU数据传输
- 支持动态分辨率适配，确保屏幕分辨率变化时自动调整裁剪区域

### 3.2 视频编码模块 (NVEncoder)

#### 3.2.1 技术实现
- 使用NVIDIA NVENC H.264硬件编码器
- 配置低延迟编码参数
- 支持CBR（恒定比特率）模式

#### 3.2.2 关键参数
| 参数 | 值 | 说明 |
|------|-----|------|
| encodeGUID | NV_ENC_CODEC_H264_GUID | H.264编码标准 |
| presetGUID | NV_ENC_PRESET_LOW_LATENCY_HQ_GUID | 低延迟高质量预设 |
| gopLength | 60 | GOP大小 |
| frameRateNum | 200 | 帧率（默认） |
| frameRateDen | 1 | 帧率分母 |
| bRefMode | 0 | 禁用B帧 |
| outputBFrames | 0 | 输出B帧数量为0 |
| rateControlMode | NV_ENC_PARAMS_RC_CBR | CBR码率控制模式 |
| averageBitRate | 15000000 | 平均码率（默认，bps） |
| maxBitRate | 15000000 | 最大码率（默认，bps） |
| enableLookahead | 0 | 禁用前瞻以减少延迟 |
| lookaheadDepth | 0 | 前瞻深度 |
| enableAQ | 1 | 启用自适应量化 |
| aqStrength | 15 | 自适应量化强度 |

### 3.3 网络传输模块 (UDPTransmitter)

#### 3.3.1 技术实现
- 使用Winsock2 API实现UDP协议
- 开发自定义轻量级UDP视频流协议
- 支持数据包分包和重组

#### 3.3.2 UDP数据包结构

| 字段 | 类型 | 大小 | 说明 |
|------|------|------|------|
| frameId | uint32_t | 4字节 | 全局唯一帧标识符 |
| packetId | uint16_t | 2字节 | 当前分包序号 |
| packetCount | uint16_t | 2字节 | 当前帧总包数 |
| timestamp | uint64_t | 8字节 | 微秒级时间戳 |
| payload | uint8_t[] | 可变 | 视频数据负载 |

#### 3.3.3 传输策略
- 无丢包重传机制，丢包直接丢弃整个视频帧
- 禁止实现多帧缓存机制，确保数据实时性
- 实现发送缓冲区流量控制，避免网络拥塞

### 3.4 多线程架构

#### 3.4.1 线程划分
- **线程1**：DXGI屏幕采集线程（高优先级）
- **线程2**：NVENC视频编码线程（高优先级）
- **线程3**：UDP数据发送线程（中优先级）

#### 3.4.2 线程间通信
- 使用无锁队列（SPSC队列）实现线程间数据传递
- 最小化缓冲区大小，每个环节缓冲区不超过2帧数据
- 实现线程间信号机制，确保资源高效利用

## 4. 依赖库清单

| 依赖库 | 版本 | 用途 | 来源 |
|--------|------|------|------|
| DirectX 11 | Windows SDK | 屏幕采集和GPU加速 | Windows系统内置 |
| DXGI 1.2 | Windows SDK | 屏幕捕获 | Windows系统内置 |
| D3DCompiler | Windows SDK | 着色器编译 | Windows系统内置 |
| Winsock2 | Windows SDK | 网络通信 | Windows系统内置 |
| NVIDIA NVENC SDK | 随显卡驱动 | 硬件编码 | NVIDIA显卡驱动 |
| nlohmann/json | v3.11.2 | JSON配置文件解析 | 项目内置 |

## 5. 系统初始化流程

### 5.1 整体初始化流程

```
1. 初始化配置管理器 (ConfigManager)
   - 加载默认配置
   - 加载命令行参数（如果有）
   - 加载配置文件（如果有）

2. 初始化LiveStreamer
   - 初始化屏幕采集模块
   - 初始化视频编码模块
   - 初始化网络传输模块

3. 启动线程
   - 启动屏幕采集线程
   - 启动视频编码线程
   - 启动网络传输线程

4. 开始推流
   - 屏幕采集线程捕获屏幕内容
   - 编码线程将采集的内容编码为H.264视频流
   - 传输线程将编码后的视频流通过UDP发送
```

### 5.2 屏幕采集模块初始化

```
1. 创建D3D11设备和设备上下文
2. 获取DXGI工厂和显示输出
3. 创建DXGI输出复制接口
4. 创建输出纹理和着色器资源视图
5. 创建着色器和采样器状态
```

### 5.3 视频编码模块初始化

```
1. 加载nvencodeapi64.dll
2. 获取NVENC API创建函数
3. 初始化NVENC API函数列表
4. 创建编码器实例
5. 配置编码参数（低延迟参数）
6. 初始化编码器
```

### 5.4 网络传输模块初始化

```
1. 初始化Winsock
2. 创建UDP套接字
3. 设置服务器地址
4. 配置套接字参数
```

## 6. 性能优化策略

### 6.1 延迟优化
- **采集延迟**：使用DXGI Desktop Duplication API，减少采集延迟
- **编码延迟**：配置NVENC低延迟参数，禁用B帧和前瞻
- **传输延迟**：使用UDP协议，无丢包重传机制
- **缓冲优化**：最小化线程间缓冲区，采用丢帧策略保持实时性

### 6.2 资源占用优化
- **GPU加速**：使用GPU进行屏幕裁剪和缩放，减少CPU占用
- **硬件编码**：使用NVENC硬件编码器，减少CPU占用
- **线程优化**：合理设置线程优先级，避免线程竞争
- **内存优化**：使用无锁队列，减少内存分配和释放

### 6.3 稳定性优化
- **错误处理**：完善的错误处理机制，确保系统稳定运行
- **资源管理**：合理管理GPU和系统资源，避免资源泄漏
- **异常捕获**：捕获和处理异常，确保系统不崩溃
- **监控机制**：监控系统状态，及时发现和处理问题

## 7. 编译和运行指南

### 7.1 编译环境
- **操作系统**：Windows 10/11（64位）
- **编译器**：Visual Studio 2019或更高版本
- **平台工具集**：v142或更高
- **Windows SDK**：10.0.19041.0或更高

### 7.2 编译步骤
1. 打开Visual Studio
2. 加载LowLatencyStreamer.sln解决方案
3. 选择Release配置和x64平台
4. 点击"生成" -> "生成解决方案"

### 7.3 运行参数

#### 7.3.1 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| --display | 显示器索引 | 0 |
| --width | 输出宽度 | 640 |
| --height | 输出高度 | 640 |
| --fps | 帧率 | 200 |
| --bitrate | 码率（kbps） | 15000 |
| --server | 服务器IP地址 | 127.0.0.1 |
| --port | 服务器端口 | 5000 |
| --max-packet-size | 最大数据包大小（字节） | 1400 |

#### 7.3.2 配置文件

配置文件名为`config.json`，放置在可执行文件同目录下：

```json
{
  "capture": {
    "displayIndex": 0,
    "outputWidth": 640,
    "outputHeight": 640
  },
  "encode": {
    "frameRate": 200,
    "bitrate": 15000
  },
  "transmit": {
    "serverIP": "127.0.0.1",
    "serverPort": 5000,
    "maxPacketSize": 1400
  }
}
```

### 7.4 运行示例

```bash
# 使用默认配置运行
LowLatencyStreamer.exe

# 使用命令行参数运行
LowLatencyStreamer.exe --display 0 --width 640 --height 640 --fps 200 --bitrate 15000 --server 192.168.1.100 --port 5000

# 使用配置文件运行
# 确保config.json文件存在于同一目录
LowLatencyStreamer.exe
```

## 8. 故障排除

### 8.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 屏幕采集失败 | 显示器索引错误 | 检查显示器索引是否正确 |
| 编码初始化失败 | 显卡不支持NVENC | 确保使用支持NVENC的NVIDIA显卡 |
| 网络发送失败 | 网络连接问题 | 检查网络连接和服务器地址 |
| 高CPU使用率 | 线程调度问题 | 检查系统负载，关闭不必要的程序 |
| 高GPU使用率 | 编码参数设置不当 | 调整编码参数，降低码率或帧率 |

### 8.2 日志和调试

- **控制台输出**：程序运行时会在控制台输出配置信息和错误信息
- **错误代码**：对于DirectX和NVENC错误，会输出详细的错误代码
- **性能监控**：使用Windows任务管理器监控CPU、GPU和内存使用情况

## 9. 代码结构

### 9.1 目录结构

```
LowLatencyStreamer/
├── include/                 # 头文件目录
│   ├── ScreenCapture.h      # 屏幕采集模块头文件
│   ├── NVEncoder.h          # 视频编码模块头文件
│   ├── UDPTransmitter.h     # 网络传输模块头文件
│   ├── LockFreeQueue.h      # 无锁队列头文件
│   ├── LiveStreamer.h       # 主控制模块头文件
│   ├── ConfigManager.h      # 配置管理模块头文件
│   └── nlohmann/            # JSON库目录
│       └── json.hpp         # JSON解析库
├── src/                     # 源代码目录
│   ├── main.cpp             # 主入口文件
│   ├── ScreenCapture.cpp    # 屏幕采集模块实现
│   ├── NVEncoder.cpp        # 视频编码模块实现
│   ├── UDPTransmitter.cpp   # 网络传输模块实现
│   ├── LiveStreamer.cpp     # 主控制模块实现
│   └── ConfigManager.cpp    # 配置管理模块实现
├── config/                  # 配置文件目录
│   └── config.json          # 示例配置文件
├── docs/                    # 文档目录
│   ├── technical_documentation.md  # 技术文档
│   └── performance_test.md  # 性能测试指南
├── LowLatencyStreamer.sln   # Visual Studio解决方案文件
└── LowLatencyStreamer.vcxproj  # Visual Studio项目文件
```

### 9.2 核心文件详解

#### 9.2.1 ScreenCapture.cpp
实现屏幕采集功能，使用DXGI Desktop Duplication API捕获屏幕内容，并通过GPU进行裁剪和缩放处理。

#### 9.2.2 NVEncoder.cpp
实现视频编码功能，使用NVIDIA NVENC H.264硬件编码器，配置低延迟参数，确保编码延迟最小化。

#### 9.2.3 UDPTransmitter.cpp
实现网络传输功能，使用UDP协议发送视频流，开发自定义轻量级UDP视频流协议，支持数据包分包和重组。

#### 9.2.4 LiveStreamer.cpp
实现多线程架构，协调各模块工作，管理线程生命周期，确保系统稳定运行。

#### 9.2.5 ConfigManager.cpp
实现配置管理功能，支持从命令行参数和配置文件加载配置，提供灵活的配置选项。

## 10. 未来发展方向

### 10.1 功能扩展
- 支持多显示器选择
- 支持窗口捕获
- 支持音频采集和编码
- 支持RTMP协议

### 10.2 性能优化
- 进一步降低延迟
- 优化GPU内存使用
- 支持更多编码格式（如H.265）
- 实现智能码率调整

### 10.3 稳定性提升
- 增加更多错误处理和恢复机制
- 实现自动重连功能
- 增加系统监控和日志记录

## 11. 总结

本项目实现了一款极低延迟的直播推流软件，通过优化屏幕采集、视频编码和网络传输环节，确保了系统的低延迟、高稳定性和良好的画质表现。该软件不依赖OBS及其相关组件，是一款独立的、专为低延迟场景设计的直播推流解决方案。

通过合理的系统架构设计、优化的编码参数配置和高效的网络传输协议，该软件能够满足实时直播、游戏直播、远程教学等对延迟要求较高的场景需求。

---

**版本**: 1.0.0
**发布日期**: 2026-02-09
**开发团队**: Windows实时音视频/直播推流工程师
